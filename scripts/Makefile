# Makefile para API Rust Monorepo
# Uso: make [target]

.PHONY: help build test clean fmt clippy docker-build docker-run docker-stop lint security-check

# VariÃ¡veis
CARGO = cargo
RUSTC = rustc
CARGO_AUDIT = cargo-audit
CARGO_TARPAULIN = cargo-tarpaulin
CARGO_DENY = cargo-deny

# Cores para output
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

# Help
help: ## Mostra esta ajuda
	@echo "$(GREEN)ğŸš€ API Rust Monorepo - Comandos disponÃ­veis:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# Build
build: ## Compila o projeto em modo debug
	@echo "$(GREEN)ğŸ”¨ Compilando projeto...$(NC)"
	$(CARGO) build
	@echo "$(GREEN)âœ… CompilaÃ§Ã£o concluÃ­da!$(NC)"

build-release: ## Compila o projeto em modo release
	@echo "$(GREEN)ğŸš€ Compilando projeto em modo release...$(NC)"
	$(CARGO) build --release
	@echo "$(GREEN)âœ… CompilaÃ§Ã£o release concluÃ­da!$(NC)"

# Testes
test: ## Executa todos os testes
	@echo "$(GREEN)ğŸ§ª Executando testes...$(NC)"
	$(CARGO) test
	@echo "$(GREEN)âœ… Testes concluÃ­dos!$(NC)"

test-watch: ## Executa testes em modo watch
	@echo "$(GREEN)ğŸ‘€ Executando testes em modo watch...$(NC)"
	$(CARGO) watch -x test

test-coverage: ## Executa testes com cobertura
	@echo "$(GREEN)ğŸ“Š Executando testes com cobertura...$(NC)"
	$(CARGO) tarpaulin --out Html
	@echo "$(GREEN)âœ… Cobertura gerada em target/tarpaulin/$(NC)"

# Limpeza
clean: ## Remove arquivos de build
	@echo "$(YELLOW)ğŸ§¹ Limpando arquivos de build...$(NC)"
	$(CARGO) clean
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

# FormataÃ§Ã£o e Linting
fmt: ## Formata o cÃ³digo
	@echo "$(GREEN)ğŸ¨ Formatando cÃ³digo...$(NC)"
	$(CARGO) fmt --all
	@echo "$(GREEN)âœ… FormataÃ§Ã£o concluÃ­da!$(NC)"

fmt-check: ## Verifica formataÃ§Ã£o do cÃ³digo
	@echo "$(GREEN)ğŸ” Verificando formataÃ§Ã£o...$(NC)"
	$(CARGO) fmt --all -- --check
	@echo "$(GREEN)âœ… FormataÃ§Ã£o OK!$(NC)"

clippy: ## Executa clippy (linter)
	@echo "$(GREEN)ğŸ” Executando clippy...$(NC)"
	$(CARGO) clippy --all-targets --all-features -- -D warnings
	@echo "$(GREEN)âœ… Clippy OK!$(NC)"

# AnÃ¡lise de SeguranÃ§a
security-check: ## Verifica vulnerabilidades de seguranÃ§a
	@echo "$(GREEN)ğŸ”’ Verificando seguranÃ§a...$(NC)"
	$(CARGO_AUDIT)
	@echo "$(GREEN)âœ… VerificaÃ§Ã£o de seguranÃ§a concluÃ­da!$(NC)"

# Docker
docker-build: ## ConstrÃ³i imagem Docker
	@echo "$(GREEN)ğŸ³ Construindo imagem Docker...$(NC)"
	docker build -t api-rust:latest .
	@echo "$(GREEN)âœ… Imagem Docker construÃ­da!$(NC)"

docker-run: ## Executa container Docker
	@echo "$(GREEN)ğŸš€ Iniciando container Docker...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)âœ… Container iniciado!$(NC)"

docker-stop: ## Para container Docker
	@echo "$(YELLOW)â¹ï¸ Parando container Docker...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ… Container parado!$(NC)"

docker-logs: ## Mostra logs do Docker
	@echo "$(GREEN)ğŸ“‹ Mostrando logs...$(NC)"
	docker-compose logs -f

# Desenvolvimento
dev: ## Inicia modo desenvolvimento
	@echo "$(GREEN)ğŸ”„ Iniciando modo desenvolvimento...$(NC)"
	$(CARGO) run

dev-watch: ## Inicia modo desenvolvimento com watch
	@echo "$(GREEN)ğŸ‘€ Iniciando modo desenvolvimento com watch...$(NC)"
	$(CARGO) watch -x run

# VerificaÃ§Ãµes
check: fmt-check clippy ## Executa todas as verificaÃ§Ãµes
	@echo "$(GREEN)âœ… Todas as verificaÃ§Ãµes passaram!$(NC)"

lint: fmt clippy ## Formata e executa clippy
	@echo "$(GREEN)âœ… Linting concluÃ­do!$(NC)"

# InstalaÃ§Ã£o de ferramentas
install-tools: ## Instala ferramentas de desenvolvimento
	@echo "$(GREEN)ğŸ“¦ Instalando ferramentas...$(NC)"
	$(CARGO) install cargo-watch
	$(CARGO) install cargo-tarpaulin
	$(CARGO) install cargo-audit
	$(CARGO) install cargo-deny
	@echo "$(GREEN)âœ… Ferramentas instaladas!$(NC)"

# AnÃ¡lise de dependÃªncias
deps-tree: ## Mostra Ã¡rvore de dependÃªncias
	@echo "$(GREEN)ğŸŒ³ Mostrando Ã¡rvore de dependÃªncias...$(NC)"
	$(CARGO) tree

deps-update: ## Atualiza dependÃªncias
	@echo "$(GREEN)â¬†ï¸ Atualizando dependÃªncias...$(NC)"
	$(CARGO) update
	@echo "$(GREEN)âœ… DependÃªncias atualizadas!$(NC)"

# Pipeline completo
pipeline: clean fmt-check clippy test build-release ## Executa pipeline completo
	@echo "$(GREEN)ğŸ‰ Pipeline completo executado com sucesso!$(NC)"

# ValidaÃ§Ã£o de produÃ§Ã£o
validate: fmt-check clippy security-check test build-release ## Valida cÃ³digo para produÃ§Ã£o
	@echo "$(GREEN)ğŸ¯ CÃ³digo validado para produÃ§Ã£o!$(NC)"

# Comandos especÃ­ficos para Windows
windows-setup: ## ConfiguraÃ§Ã£o especÃ­fica para Windows
	@echo "$(YELLOW)ğŸªŸ ConfiguraÃ§Ã£o para Windows...$(NC)"
	@echo "Instalando ferramentas necessÃ¡rias..."
	@echo "1. Visual Studio Build Tools"
	@echo "2. Rust via rustup"
	@echo "3. Docker Desktop"
	@echo "$(GREEN)âœ… ConfiguraÃ§Ã£o para Windows concluÃ­da!$(NC)"

# Comandos especÃ­ficos para Linux
linux-setup: ## ConfiguraÃ§Ã£o especÃ­fica para Linux
	@echo "$(YELLOW)ğŸ§ ConfiguraÃ§Ã£o para Linux...$(NC)"
	@echo "Instalando dependÃªncias..."
	sudo apt-get update
	sudo apt-get install -y build-essential pkg-config libssl-dev
	@echo "$(GREEN)âœ… ConfiguraÃ§Ã£o para Linux concluÃ­da!$(NC)"

# Comandos especÃ­ficos para macOS
macos-setup: ## ConfiguraÃ§Ã£o especÃ­fica para macOS
	@echo "$(YELLOW)ğŸ ConfiguraÃ§Ã£o para macOS...$(NC)"
	@echo "Instalando dependÃªncias..."
	brew install openssl pkg-config
	@echo "$(GREEN)âœ… ConfiguraÃ§Ã£o para macOS concluÃ­da!$(NC)"

# Status do projeto
status: ## Mostra status do projeto
	@echo "$(GREEN)ğŸ“Š Status do Projeto:$(NC)"
	@echo "Rust version: $(shell rustc --version)"
	@echo "Cargo version: $(shell cargo --version)"
	@echo "Target: $(shell rustup show | grep "Default host" | cut -d: -f2 | tr -d ' ')"
	@echo "Features: $(shell cargo --list | grep -c "cargo-")"
	@echo "$(GREEN)âœ… Status verificado!$(NC)"
